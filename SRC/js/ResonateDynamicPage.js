var DynamicObjectDefinition=Class.extend({init:function(){this.tag;this.classDef;this.params=new Array;this.properties=new Array;this.isNonVisible=false},getParam:function(name){var i;for(i=0;i<this.params.length;i++)if(this.params[i]===name)return this.params[i];return null},hasParam:function(name){return!(this.getParam(name)==null)},getProperty:function(name){var i;for(i=0;i<this.properties.length;i++)if(this.properties[i]===name)return this.properties[i];return null},hasProperty:function(name){return!(this.getProperty(name)==
null)},isCSSStyle:function(name){return!this.hasParam(name)&&!this.hasProperty(name)},construct:null,parser:null,getMediaList:null,postRender:null});var DynamicObjectDefinitions=EventDispatcher.extend({init:function(){this._super();this.items=new Object},registerObjectDef:function(tag,data){this.items[tag]=data},findObjectDef:function(tagName){var result=null;if(this.items[tagName])result=this.items[tagName];return result}});var DynamicObjectDefs=new DynamicObjectDefinitions;var DynamicObject=EventDispatcher.extend({init:function(){this._super();this.objects=new Array;this.events=new Array;this._objDef=null;this.value="";this.params=new Object},getEvent:function(name){var i;for(i=0;i<this.events.length;i++)if(this.events[i].name==name)return this.events[i];return null},addEvent:function(name,script){this.events.push({name:name,script:script})},getMediaList:function(){var result=[];if(this._objDef.getMediaList)if(typeof this._objDef.getMediaList=="function")result=this._objDef.getMediaList(this);
else{var objData=this;result=eval(this._objDef.getMediaList)}return result}});var DynamicPage=EventDispatcher.extend({init:function(xmlFile,pageContentObj,loadedEventHandler){this._super();this.xmlFile=xmlFile;this.pageContentObj=pageContentObj;this.objects=new Array;this.events=new Array;this.nameSpaces=new Object;this._preloadFiles=new Array;if(loadedEventHandler)this.addListener("onLoaded",loadedEventHandler);if(this.xmlFile)this.loadFromXML(this.xmlFile)},loadFromXML:function(xmlFile){console.log("get xml file : "+xmlFile);$.ajax({type:"GET",url:xmlFile,dataType:"xml",
context:this,success:this._parseXML,error:this._handleLoadError,headers:{"Cache-Control":"max-age=2700"}})},loadTemplate:function(id,xmlFile){console.log("get template file : "+xmlFile);var self=this;$.ajax({type:"GET",url:xmlFile,dataType:"xml",context:this,success:function(xml){self._parseTemplate(id,xml)},error:this._handleLoadError,headers:{"Cache-Control":"max-age=2700"}})},_parseTemplate:function(id,xml){},_parseXML:function(xml){var i;this._parseRootNode(xml.childNodes[0]);for(i=0;i<this.events.length;i++)this.addListener(this.events[i].name,
this._handlePageEvent,this);this.dispatch("onLoaded");this.dispatch("onPageLoad")},_parseRootNode:function(node){var attr=this._parseAttributes(node);var p;var self=this;for(p in attr)if(p.indexOf("xmlns")==0)this.addNameSpace(p.substr(5),attr[p]);$.each(node.childNodes,function(i,childNode){console.log("found root level "+childNode.nodeName);switch(childNode.nodeName){case "cb:CSS":self._parseCSS(childNode);break;case "cb:Event":self.events.push(self._parseEvent(childNode));break;case "cb:Script":self._parseScript(childNode);
break;case "cb:Map":self._parseMap(childNode);break;case "cb:Preload":self._parsePreload(childNode);break;default:def=DynamicObjectDefs.findObjectDef(childNode.nodeName);if(def)self.objects.push(self._parseObject(childNode,def));break}})},_parseCSS:function(node){console.log("found css");console.log(node);var scr;var attrs=this._parseAttributes(node);console.log("css attributes");console.log(attrs);scr=node.childNodes[0].nodeValue.replace(/^\s+/,"").replace(/\s+$/,"").trim();if(attrs.linked!=undefined&&
attrs.linked==true){if($("#stage")&&(scr&&scr!==""))$("#stage").append('<link rel="stylesheet" type="text/css" href="'+scr+'">')}else if($("#stage")&&(scr&&scr!==""))$("#stage").append('<style type="text/css">'+scr+"</style>")},_parseScript:function(node){console.log("found a script");var scr=node.childNodes[0].nodeValue.replace(/^\s+/,"").replace(/\s+$/,"").trim();if($("#stage")&&(scr&&scr!==""))$("#stage").append('<script type="text/javascript">'+scr+"\x3c/script>")},_parseMap:function(node){console.log("found a map");
var scr=node.childNodes[0].nodeValue.replace(/^\s+/,"").replace(/\s+$/,"").trim();var attrs=this._parseAttributes(node);if($("#stage")&&(scr&&scr!==""))$("#stage").append('<map name="'+attrs.id+'">'+scr+"</map>")},_parsePreload:function(node){console.log("found a preload");console.log(node);var scr=node.childNodes[0].nodeValue.replace(/^\s+/,"").replace(/\s+$/,"").trim();this._preloadFiles.push(scr)},_parseEvent:function(node){var result=new Object;var attr=this._parseAttributes(node);var self=this;
for(p in attr)result[p]=attr[p];result.script=null;result.tween=new Array;$.each(node.childNodes,function(i,childNode){switch(childNode.nodeName){case "cb:Script":result.script=childNode.childNodes[0].nodeValue.replace(/^\s+/,"").replace(/\s+$/,"").trim();break}});return result},_parseObject:function(node,objDef){var result=new DynamicObject;result._objDef=objDef;result.value="";result.rawValue="";var attr=this._parseAttributes(node);var self=this;for(p in attr)result.params[p]=attr[p];$.each(node.childNodes,
function(i,childNode){switch(childNode.nodeName){case "cb:Event":result.events.push(self._parseEvent(childNode));break;case "cb:Value":result.value=childNode.childNodes[0].nodeValue.replace(/^\s+/,"").replace(/\s+$/,"").trim();result.rawValue=result.value;if(result.value.indexOf("@=")==0)result.value=self._resolveValue(result.value);break;default:def=DynamicObjectDefs.findObjectDef(childNode.nodeName);if(def)result.objects.push(self._parseObject(childNode,def));break}});if(objDef.parser)objDef.parser(node,
result);return result},_parseAttributes:function(node){var result=new Object;var self=this;if(node.attributes&&node.attributes.length>0)$.each(node.attributes,function(i,attribute){result[attribute.name]=self._resolveValue(attribute.value)});return result},_resolveValue:function(value){var page=this;if(value.indexOf("@=")==0){value=eval(value.substring(2));return value}value=value.toLowerCase()=="true"?true:value.toLowerCase()=="false"?false:value;if($.isNumeric(value))value=parseFloat(value);return value},
_handleLoadError:function(err,errString,errThrown){console.log("Error Loading XML file: ");console.log(err);console.log(errString)},addNameSpace:function(nsName,nsURL){this.nameSpaces[nsName]=nsURL},renderPage:function(){var i;for(i=0;i<this.objects.length;i++)this.renderObject(this.objects[i]);this.dispatch("onPageRender")},renderObject:function(objData){if(!objData.parent)objData.parent=this.pageContentObj;var i;var eventHandler;var obj;if(objData._objDef.isNonVisible)if(typeof objData._objDef.construct==
"function")obj=objData.parent.addNonVisibleChild(objData.params.id,objData._objDef.construct(objData));else return;else if(typeof objData._objDef.construct=="function")obj=objData.parent.addChild(objData._objDef.construct(objData));else return;objData.pointer=obj;objData.dynPage=this;for(var p in objData.params)switch(p.toLowerCase()){case "cssclass":temp=objData.params[p].split(",");for(i=0;i<temp.length;i++)objData.pointer.setClass(temp[i],false);break;default:if(objData._objDef.isCSSStyle(p))objData.pointer.setCSS(p,
objData.params[p]);else if(objData._objDef.hasProperty(p))objData.pointer[p]=objData.params[p];break}for(i=0;i<objData.events.length;i++)objData.pointer.addListener(objData.events[i].name,this._handleObjectEvent,objData);if(typeof objData._objDef.postRender=="function")objData._objDef.postRender(objData);objData.pointer.dispatch("onRender");for(i=0;i<objData.objects.length;i++){objData.objects[i].parent=obj;this.renderObject(objData.objects[i])}},_handleObjectEvent:function(event){var eventObj=event.context.getEvent(event.eventName);
if(eventObj){var eventHandler="var page = event.context.dynPage; var self = event.sender; var sender = event.sender;"+eventObj.script;eval(eventHandler)}},_handlePageEvent:function(event){eventObj=event.context.getEvent(event.eventName);if(eventObj){var eventHandler="var page = event.context; var self = event.context; var sender = event.context;"+eventObj.script;eval(eventHandler)}},getEvent:function(name){var i;for(i=0;i<this.events.length;i++)if(this.events[i].name==name)return this.events[i];return null},
getObjectDef:function(uri){var parts=uri.split(".");var i;var startObj=this;for(i=0;i<parts.length;i++)if(startObj!=null)startObj=this.findObject(parts[i],startObj);else console.log("errored out "+i);return startObj},getObject:function(uri){var obj=this.getObjectDef(uri);if(obj)return obj.pointer;return null},getObjectParams:function(uri){var obj=this.getObjectDef(uri);if(obj)return obj.params;return null},getObjectParam:function(uri,param){var obj=this.getObjectDef(uri);if(obj)return obj.params[param]||
null;return null},findObject:function(name,startObj){var i;for(i=0;i<startObj.objects.length;i++)if(startObj.objects[i].params.id&&startObj.objects[i].params.id==name)return startObj.objects[i];return null},getMediaList:function(){var i;var j;var result=new Array;var temp;for(i=0;i<this.objects.length;i++){temp=this.objects[i].getMediaList();for(j=0;j<temp.length;j++)if(result.indexOf(temp[j])==-1)result.push(temp[j])}for(i=0;i<this._preloadFiles.length;i++)result.push(this._preloadFiles[i]);return result},
refreshValue:function(name){return this._resolveValue(dynPage.getObjectDef(name).rawValue)}});var ImageObjDef=DynamicObjectDefinition.extend({init:function(){this._super();this.tag="cb:Image";this.classDef=ImageObj;this.params=["id","x","y","width","height"];this.properties=["enabled","draggable","droppable"]},construct:function(objData){var style=new ImageStyle;style.draggable=objData.params.draggable||false;style.droppable=objData.params.droppable||false;var result=new ImageObj(objData.params.id,objData.params.x,objData.params.y,objData.params.width,objData.params.height,style,objData.value);
console.log("new Image obj");console.log(result);return result},getMediaList:function(objData){return[objData.value]}});(function(){var def=new ImageObjDef;if(typeof DynamicObjectDefs!="undefined")DynamicObjectDefs.registerObjectDef(def.tag,def);else console.log("Attempt to register "+def.tag+" failed")})();var AudioObjDef=DynamicObjectDefinition.extend({init:function(){this._super();this.tag="cb:Audio";this.classDef=SoundEx;this.isNonVisible=true;this.params=["id","value","autoPlay"]},construct:function(objData){var i;var result=new SoundEx(objData.value,objData.params.autoPlay);for(i=0;i<objData.triggers.length;i++)result.addTrigger(objData.triggers[i]);return result},getMediaList:function(objData){return[objData.value]},parser:function(node,objData){objData.triggers=new Array;var i;var hasTrigger=
false;var triggerEventCode=" console.log(event); switch(event.index){";$.each(node.childNodes,function(i,childNode){switch(childNode.nodeName){case "cb:Trigger":hasTrigger=true;objData.triggers.push(childNode.attributes.getNamedItem("time").value/1E3||0);triggerEventCode+="case "+(objData.triggers.length-1)+":";$.each(childNode.childNodes,function(j,childNode2){console.log(childNode2);switch(childNode2.nodeName){case "cb:Script":triggerEventCode+=childNode2.childNodes[0].nodeValue.replace(/^\s+/,
"").replace(/\s+$/,"").trim();break}});triggerEventCode+="break;";break}});triggerEventCode+="}";if(hasTrigger)objData.addEvent("onTrigger",triggerEventCode)}});(function(){var def=new AudioObjDef;if(typeof DynamicObjectDefs!="undefined")DynamicObjectDefs.registerObjectDef(def.tag,def);else console.log("Attempt to register "+def.tag+" failed")})();var VideoObjDef=DynamicObjectDefinition.extend({init:function(){this._super();this.tag="cb:Video";this.classDef=Video;this.isNonVisible=false;this.params=["id","x","y","width","height","value","autoPlay","controls"]},construct:function(objData){var i;console.log("objData");console.log(objData.params.controls);console.log("objData");console.log(objData);var result=new Video(objData.params.id,objData.params.x,objData.params.y,new VideoStyle(objData.params.width,objData.params.height),objData.value,
objData.params.autoPlay,objData.params.controls);for(i=0;i<objData.triggers.length;i++)result.addTrigger(objData.triggers[i]);return result},getMediaList:function(objData){return[]},parser:function(node,objData){objData.triggers=new Array;var i;var hasTrigger=false;var triggerEventCode=" console.log(event); switch(event.index){";$.each(node.childNodes,function(i,childNode){switch(childNode.nodeName){case "cb:Trigger":hasTrigger=true;objData.triggers.push(childNode.attributes.getNamedItem("time").value/
1E3||0);triggerEventCode+="case "+(objData.triggers.length-1)+":";$.each(childNode.childNodes,function(j,childNode2){console.log(childNode2);switch(childNode2.nodeName){case "cb:Script":triggerEventCode+=childNode2.childNodes[0].nodeValue.replace(/^\s+/,"").replace(/\s+$/,"").trim();break}});triggerEventCode+="break;";break}});triggerEventCode+="}";if(hasTrigger)objData.addEvent("onTrigger",triggerEventCode)}});
(function(){var def=new VideoObjDef;if(typeof DynamicObjectDefs!="undefined")DynamicObjectDefs.registerObjectDef(def.tag,def);else console.log("Attempt to register "+def.tag+" failed")})();var TextObjDef=DynamicObjectDefinition.extend({init:function(){this._super();this.tag="cb:Text";this.classDef=TextArea;this.params=["id","x","y","width","height","value"]},construct:function(objData){var style=new TextAreaStyle(objData.params.width,objData.params.height);console.log(objData);var result=new TextArea(objData.params.id,objData.params.x,objData.params.y,style);result.setText(objData.value);return result},getMediaList:function(objData){return[]}});
(function(){var def=new TextObjDef;if(typeof DynamicObjectDefs!="undefined")DynamicObjectDefs.registerObjectDef(def.tag,def);else console.log("Attempt to register "+def.tag+" failed")})();var DivObjDef=DynamicObjectDefinition.extend({init:function(){this._super();this.tag="cb:Div";this.classDef=DivObj;this.params=["id","x","y","width","height"];this.properties=["enabled"]},construct:function(objData){var result=new DivObj(objData.params.id,objData.params.x,objData.params.y,new UIStyle(objData.params.width,objData.params.height));result.setCSS("left",objData.params.x+"px");result.setCSS("top",objData.params.y+"px");if(objData.params.width!="auto")result.setCSS("width",objData.params.width+
"px");if(objData.params.height!="auto")result.setCSS("height",objData.params.height+"px");$(result.divObject).html(objData.value);return result},getMediaList:function(objData){return[]}});(function(){var def=new DivObjDef;if(typeof DynamicObjectDefs!="undefined")DynamicObjectDefs.registerObjectDef(def.tag,def);else console.log("Attempt to register "+def.tag+" failed")})();var TimerObjDef=DynamicObjectDefinition.extend({init:function(){this._super();this.tag="cb:Timer";this.classDef=Timer;this.isNonVisible=true;this.params=["id","interval","repeat","autoStart"]},construct:function(objData){var i;var result=new Timer(objData.params.interval,objData.params.repeat);for(i=0;i<objData.triggers.length;i++)result.addTrigger(objData.triggers[i]);return result},getMediaList:function(objData){return[]},parser:function(node,objData){objData.triggers=new Array;var i;var hasTrigger=
false;var triggerEventCode=" console.log(event); switch(event.index){";$.each(node.childNodes,function(i,childNode){switch(childNode.nodeName){case "cb:Trigger":hasTrigger=true;objData.triggers.push(childNode.attributes.getNamedItem("time").value||0);triggerEventCode+="case "+(objData.triggers.length-1)+":";$.each(childNode.childNodes,function(j,childNode2){switch(childNode2.nodeName){case "cb:Script":triggerEventCode+=childNode2.childNodes[0].nodeValue.replace(/^\s+/,"").replace(/\s+$/,"").trim();
break}});triggerEventCode+="break;";break}});triggerEventCode+="}";if(hasTrigger)objData.addEvent("onTrigger",triggerEventCode)},postRender:function(objData){console.log("in Post Render");console.log(objData);if(objData.params.autoStart)objData.pointer.start()}});(function(){var def=new TimerObjDef;if(typeof DynamicObjectDefs!="undefined")DynamicObjectDefs.registerObjectDef(def.tag,def);else console.log("Attempt to register "+def.tag+" failed")})();var DialogObjDef=DynamicObjectDefinition.extend({init:function(){this._super();this.tag="cb:Dialog";this.classDef=Dialog;this.params=["id","x","y","width","height","draggable"];this.properties=[]},construct:function(objData){var innerDiv=$("<div id="+objData.params.id+'_div" title="'+objData.title+'"/>');$(innerDiv).html(objData.value);var stagePos=$("#stage").offset();console.log(stagePos);var result=new Dialog("dialog",0,0,innerDiv,new DialogStyle({position:[stagePos.left+objData.params.x,stagePos.top+
objData.params.y]}));result.divObject.dialog("option","width",objData.params.width);result.divObject.dialog("option","height",objData.params.height);result.divObject.dialog("option","draggable",objData.params.draggable||false);return result},getMediaList:function(objData){return[]},parser:function(node,objData){objData.title="";var i;$.each(node.childNodes,function(i,childNode){switch(childNode.nodeName){case "cb:Title":objData.title=childNode.childNodes[0].nodeValue.replace(/^\s+/,"").replace(/\s+$/,
"").trim();break}})}});(function(){var def=new DialogObjDef;if(typeof DynamicObjectDefs!="undefined")DynamicObjectDefs.registerObjectDef(def.tag,def);else console.log("Attempt to register "+def.tag+" failed")})();var ButtonObjDef=DynamicObjectDefinition.extend({init:function(){this._super();this.tag="cb:Button";this.classDef=StandardButton;this.params=["id","x","y","width","height","value","captionX","captionY","captionWidth","captionHeight"];this.properties=["enabled"]},construct:function(objData){result=new StandardButton(objData.params.id,objData.params.x,objData.params.y,new StandardButtonStyle(objData.params.width,objData.params.height));var caption=result.addChild(new TextArea("caption",objData.params.captionX||
0,objData.params.captionY||10,new TextAreaStyle(objData.params.captionWidth||objData.params.width,objData.params.captionHeight||objData.params.height-10)));caption.setText(objData.value);console.log(objData.params.cssStyle);if(objData.params.cssClass&&objData.params.cssClass.length){console.log("remove class");result.removeClass("standardButton")}return result},getMediaList:function(objData){return[]}});
(function(){var def=new ButtonObjDef;if(typeof DynamicObjectDefs!="undefined")DynamicObjectDefs.registerObjectDef(def.tag,def);else console.log("Attempt to register "+def.tag+" failed")})();var SVGObjDef=DynamicObjectDefinition.extend({init:function(){this._super();this.tag="cb:SVG";this.classDef=SVG;this.params=["id","x","y","width","height","value"]},construct:function(objData){result=new SVG(objData.params.id,objData.params.x,objData.params.y,new SVGStyle(objData.params.width,objData.params.height,{file:objData.value}),function(e){console.log("svg loaded");console.log(e);e.sender.dispatch("onLoaded")});return result},getMediaList:function(objData){return[objData.value]}});
(function(){var def=new SVGObjDef;if(typeof DynamicObjectDefs!="undefined")DynamicObjectDefs.registerObjectDef(def.tag,def);else console.log("Attempt to register "+def.tag+" failed")})();var SliderObjDef=DynamicObjectDefinition.extend({init:function(){this._super();this.tag="cb:Slider";this.classDef=Slider;this.params=["id","x","y","width","height","value","orientation","min","max","initial"]},construct:function(objData){var result;if(objData.params.orientation.toLowerCase().indexOf("v")==0)result=new Slider(objData.params.id,objData.params.x,objData.params.y,new VerticalSliderStyle(objData.params.length,{max:objData.params.max||0,min:objData.params.min||0,orientation:"vertical"}));
else result=new Slider(objData.params.id,objData.params.x,objData.params.y,new HorizontalSliderStyle(objData.params.length,{max:objData.params.max||0,min:objData.params.min||0,orientation:"horizontal"}));return result},getMediaList:function(objData){return[]}});(function(){var def=new SliderObjDef;if(typeof DynamicObjectDefs!="undefined")DynamicObjectDefs.registerObjectDef(def.tag,def);else console.log("Attempt to register "+def.tag+" failed")})();