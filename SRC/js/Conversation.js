var Actor=EventDispatcher.extend({init:function(a){this._super();this.name=this.id="";this.states=new KeyCollection;a&&this.parseNode(a)},addState:function(a,b){this.states.add(a,b)},getState:function(a){return this.states.getValue(a)},getInitState:function(){return this.states.items[0].value},parseNode:function(a){var b,c;a=$(a);this.id=a.attr("id");this.name=a.attr("name");for(b=0;b<$(a).children().length;b++)switch(c=$($(a).children()[b]).get(0),c.nodeName){case "state":this.states.add($(c).attr("id"),
$(c).text())}}});var ActorAction=EventDispatcher.extend({init:function(a,b){this._super();this.actionType="dialog";this.actor=a;this.text=this.audio=this.state="";this.index=-1;b&&this.parseAction(b)},parseAction:function(a){a=$(a);this.state=a.attr("state");this.audio=a.attr("audio");this.text=a.text()}});var QuestionAction=MultipleChoiceQuestion.extend({init:function(a,b){this.actionType="question";this.index=-1;void 0==b&&(b=!0);this._super(b);a&&this.parseQuestionXML(a)}});var InformationAction=EventDispatcher.extend({init:function(a){this._super();this.actionType="information";this.text=this.audio="";this.branch=this.index=-1;a&&this.parseAction(a)},parseAction:function(a){a=$(a);this.audio=a.attr("audio");a.attr("branch")&&(this.branch=a.attr("branch"));this.text=a.text()}});var ConversationActions=EventDispatcher.extend({init:function(a,b){this._super();this.conversation=a;this.id="id";this.actions=[];this.currentAction=0;this.index=-1;b&&this.parseActions(b)},getCount:function(){return this.actions.length},addAction:function(a){a.index=this.actions.length;this.actions.push(a)},getAction:function(a){return a<this.getCount()?(this.currentAction=a,this.actions[a]):null},getFirstAction:function(){this.currentAction=0;return this.getAction(0)},getNextAction:function(){return this.currentAction+
1<this.actions.length?this.getAction(++this.currentAction):null},getPreviousAction:function(){return 0<this.currentAction-1?this.getAction(--this.currentAction):null},parseActions:function(a){var b,c;a=$(a);this.id=a.attr("id");for(b=0;b<a.children().length;b++)switch(c=$(a.children()[b]).get(0),c.nodeName){case "actor":this.addAction(new ActorAction(this.conversation.getActor($(c).attr("id")),c));break;case "question":this.addAction(new QuestionAction(c));break;case "information":this.addAction(new InformationAction(c))}}});var Conversation=EventDispatcher.extend({init:function(a,b){this._super();this.xmlFile=a;this.actors=new KeyCollection;this.actionSets=[];this.currentActionSet=0;this.userPath=[];b&&this.addListener("onLoaded",b);this.loadXML(a)},addActor:function(a){a.index=this.actors.getCount();this.actors.add(a.id,a)},getActor:function(a){return this.actors.getValue(a)},addActionSet:function(a){this.actionSets.push(a)},getActionSet:function(a){this.currentActionSet=a;this.userPath.push(this.actionSets[a].id);
return this.actionSets[a]},getFirstActionSet:function(){return this.getActionSet(0)},getNextActionSet:function(){return this.currentActionSet+1<this.actions.length?this.getActionSet(++this.currentActionSet):null},getActionSetByID:function(a){var b;for(b=0;b<this.actionSets.length;b++)if(this.actionSets[b].id==a)return this.getActionSet(b);return null},getAction:function(a,b){try{return this.getActionSetByID(a).getAction(b)}catch(c){return null}},getFirstAction:function(a){return void 0!=a?this.getAction(a,
0):this.actionSets[0].getFirstAction()},getNextAction:function(a){void 0==a&&(a=this.currentActionSet);return this.getActionSet(a).getNextAction()},loadXML:function(a){$.ajax({type:"GET",url:a,dataType:"xml",context:this,success:this.parseXML})},parseXML:function(a){var b=$(a).find("conversation"),c;for(a=0;a<$(b).children().length;a++)switch(c=$($(b).children()[a]).get(0),c.nodeName){case "actor":this.parseActorDetails(c);break;case "actionSet":this.parseActionSet(c)}this.dispatch("onLoaded")},parseActorDetails:function(a){this.addActor(new Actor(a))},
parseActionSet:function(a){this.addActionSet(new ConversationActions(this,a))},getUserPath:function(){for(var a="",b=-1,c=0;c<this.userPath.length;c++)this.userPath[c]!=b&&(b=this.userPath[c],a+=(""==a?"":",")+b);return a}});